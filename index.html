<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QUINA 2025 PRO</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --primary: #ffffff; --accent: #10b981; --bg: #020617; --gold: #fbbf24; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: white; margin: 0; display: flex; justify-content: center; min-height: 100vh; }
        .container { width: 95%; max-width: 600px; padding: 20px; text-align: center; }
        .card { background: rgba(255,255,255,0.05); padding: 20px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); margin-bottom: 20px; }
        .btn { padding: 15px 25px; border-radius: 50px; border: none; font-weight: bold; cursor: pointer; text-transform: uppercase; margin: 5px; width: 100%; max-width: 300px; transition: 0.2s; }
        .btn-primary { background: white; color: var(--bg); }
        .btn-accent { background: var(--accent); color: white; }
        .btn-spotify { background: #1DB954; color: white; }
        .room-id { font-size: 3rem; font-weight: 900; color: var(--accent); letter-spacing: 5px; }
        .current-song { background: white; color: var(--bg); padding: 20px; border-radius: 15px; font-size: 1.8rem; font-weight: 900; margin: 15px 0; }
        .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 15px; }
        .cell { background: rgba(255,255,255,0.1); border-radius: 10px; min-height: 70px; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; padding: 5px; font-weight: bold; cursor: pointer; border: 1px solid transparent; }
        .cell.marked { background: var(--accent); border-color: white; }
        .history { text-align: left; font-size: 0.8rem; background: rgba(0,0,0,0.4); padding: 10px; border-radius: 10px; max-height: 80px; overflow-y: auto; }
        #winner-overlay { position: fixed; inset: 0; background: rgba(2,6,23,0.98); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 999; }
        .hidden { display: none; }
        input { padding: 15px; border-radius: 50px; border: none; width: 80%; margin: 10px 0; text-align: center; }
    </style>
</head>
<body>

<div id="winner-overlay">
    <div style="background: var(--gold); color: black; padding: 40px; border-radius: 30px; text-align: center;">
        <h1 style="font-size: 3rem; margin: 0;">üèÜ QUINA!</h1>
        <p id="winner-name" style="font-size: 1.5rem; font-weight: 900;"></p>
        <button class="btn" style="background: black; color: white;" onclick="document.getElementById('winner-overlay').style.display='none'">CONTINUAR</button>
    </div>
</div>

<div class="container">
    <div id="view-home">
        <h1>QUINA 2025</h1>
        <button class="btn btn-primary" onclick="initAdmin()">ORGANITZADOR</button><br>
        <button class="btn" style="background: #333; color: white;" onclick="showView('view-join')">JUGADOR</button>
    </div>

    <div id="view-join" class="hidden">
        <h2>ENTRA A LA SALA</h2>
        <input type="number" id="join-room-id" placeholder="CODI DE 4 XIFRES">
        <input type="text" id="join-name" placeholder="EL TEU NOM">
        <button class="btn btn-primary" onclick="connectToAdmin()">ENTRAR</button>
    </div>

    <div id="view-card" class="hidden">
        <h3 id="player-info" style="margin: 0;"></h3>
        <div id="player-num" style="color: var(--accent); margin-bottom: 10px; font-size: 0.8rem;"></div>
        <div class="grid" id="grid-cartro"></div>
        <button class="btn btn-accent" style="margin-top: 15px;" onclick="resetCard()">NETEJAR CARTR√ì</button>
    </div>

    <div id="view-admin" class="hidden">
        <div class="card">
            <p style="margin: 0; font-size: 0.8rem;">CODI DE SALA</p>
            <div class="room-id" id="display-room-id">----</div>
            <div class="current-song" id="active-song">PREPARATS?</div>
            <button class="btn btn-accent" onclick="drawSong()">üé∂ TREURE CAN√á√ì</button>
            <button class="btn btn-spotify" onclick="openSpotify()">üéß SPOTIFY</button>
        </div>
        <div class="card" style="text-align: left;">
            <strong>HISTORIAL:</strong>
            <div id="history-list" class="history"></div>
        </div>
        <div class="card" style="text-align: left;">
            <strong>JUGADORS (<span id="p-count">0</span>):</strong>
            <div id="p-list" style="font-size: 0.8rem; opacity: 0.7;"></div>
        </div>
    </div>
</div>

<script>
    const CANCONS = [
        "A la fresKa - Figa Flawas", "Abracadabra - Lady Gaga", "Berghain - Rosal√≠a", "Bon dia - Els Pets", "Daddy Cool - Boney M.", 
        "Danza Kunduro - Don Omar", "Espresso Macchiato - Tommy Cash", "Everybody - Backstreet Boys", "Hay que venir al sur - Raffaella Carr√†", 
        "It's Not Unusual - Tom Jones", "Me col√© en una fiesta - Mecano", "No m'estima + - Mushka Julieta", "Nuevayol - Bad Bunny", 
        "Para no verte mas - La Mosca", "Pedro - Raffaella Carr√†", "Rehab - Amy Winehouse", "Saturday Night - Whigfield", "Shake it Off - Taylor Swift", 
        "Shape of you - Ed Sheeran", "Si tothom calla - Gertrudis", "Sofia - √Ålvaro Soler", "Sta Guai - Oques Grasses", "Sweet Caroline - DJ √ñtzi", 
        "T√†ndem - The Tyets", "The Look - Roxette", "Think - Aretha Franklin", "Todo de ti - Rauw Alejandro", "Viva la Vida - Coldplay", "Wannabe - Spice Girls", "YMCA - Village People"
    ];

    let cartrons = [];
    for(let i=0; i<200; i++) cartrons.push([...CANCONS].sort(()=>0.5-Math.random()).slice(0,9));

    let bombo = [...CANCONS], sortides = [], players = [], peer, conn, currentSong = "";

    function showView(id) {
        document.querySelectorAll('.container > div').forEach(d => d.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }

    function initAdmin() {
        const id = Math.floor(1000 + Math.random() * 9000).toString();
        peer = new Peer('QUINA-PRO-' + id);
        peer.on('open', () => { 
            document.getElementById('display-room-id').innerText = id; 
            showView('view-admin'); 
        });
        peer.on('connection', c => {
            c.on('data', data => {
                if(data.type === 'join') {
                    if(!players.includes(data.name)) players.push(data.name);
                    updateAdmin();
                    c.send({type: 'welcome', idx: Math.floor(Math.random() * 200)});
                }
                if(data.type === 'win') {
                    document.getElementById('winner-name').innerText = data.name;
                    document.getElementById('winner-overlay').style.display = 'flex';
                }
            });
        });
    }

    function updateAdmin() {
        document.getElementById('p-count').innerText = players.length;
        document.getElementById('p-list').innerText = players.join(", ");
        document.getElementById('history-list').innerText = sortides.join(", ");
    }

    function drawSong() {
        if(!bombo.length) return alert("Fi!");
        currentSong = bombo.splice(Math.floor(Math.random()*bombo.length), 1)[0];
        sortides.unshift(currentSong);
        document.getElementById('active-song').innerText = currentSong;
        updateAdmin();
    }

    function openSpotify() { if(currentSong) window.location.href=`spotify:search:${encodeURIComponent(currentSong)}`; }

    function connectToAdmin() {
        const rid = document.getElementById('join-room-id').value;
        const name = document.getElementById('join-name').value;
        if(!rid || !name) return alert("Posa el codi i el nom");
        peer = new Peer();
        peer.on('open', () => {
            conn = peer.connect('QUINA-PRO-' + rid);
            conn.on('open', () => conn.send({type: 'join', name: name}));
            conn.on('data', d => { if(d.type === 'welcome') renderPlayer(d.idx, name); });
        });
    }

    function renderPlayer(idx, name) {
        document.getElementById('player-info').innerText = name.toUpperCase();
        document.getElementById('player-num').innerText = "CARTR√ì #" + (idx + 1);
        const g = document.getElementById('grid-cartro'); g.innerHTML = '';
        cartrons[idx].forEach(c => {
            const div = document.createElement('div');
            div.className = 'cell'; div.innerText = c;
            div.onclick = () => {
                div.classList.toggle('marked');
                if(document.querySelectorAll('.cell.marked').length === 9) conn.send({type:'win', name: name});
            };
            g.appendChild(div);
        });
        showView('view-card');
    }

    function resetCard() { document.querySelectorAll('.cell').forEach(c => c.classList.remove('marked')); }
</script>
</body>
</html>
